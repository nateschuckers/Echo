<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communications Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* --- Base Theme Variables --- */
        :root {
            --color-primary: 217 91% 60%;
            --color-primary-hover: 217 91% 55%;
            --color-primary-foreground: 210 40% 98%;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Dynamic styles for theme colors */
        .text-primary { color: hsl(var(--color-primary)); }
        .bg-primary { background-color: hsl(var(--color-primary)); }
        .bg-primary-hover:hover { background-color: hsl(var(--color-primary-hover)); }
        .text-primary-foreground { color: hsl(var(--color-primary-foreground)); }
        .border-primary { border-color: hsl(var(--color-primary)); }
        .ring-primary { ring-color: hsl(var(--color-primary)); }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; border: 3px solid transparent; }
        
        /* --- General Inputs --- */
        .filter-input {
            width: 100%;
            background-color: #1f2937; /* dark:bg-gray-900 -> bg-gray-800 in real app but this is iframe */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #d1d5db; /* dark:text-gray-300 */
        }
        
        /* --- Email Builder Specific --- */
        .preview-btn.active { background-color: hsl(var(--color-primary)); color: hsl(var(--color-primary-foreground)); }
        .toolbox-tab-btn.active { border-color: hsl(var(--color-primary)); color: hsl(var(--color-primary)); }
        .template-card { cursor: pointer; transition: transform 0.2s; }
        .template-card:hover { transform: scale(1.05); }
        .toolbox-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            cursor: grab;
            transition: background-color 0.2s;
        }
        .toolbox-item:hover {
             background-color: #4b5563; /* dark:bg-gray-600 */
        }


        /* --- Log/List Styles (Used by Comms, Receipts & Statements) --- */
        .log-list-container {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
        }
        .list-header {
            display: grid;
            gap: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af; /* gray-400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            align-items: center;
        }
        .comm-list-header { grid-template-columns: 48px 2fr 1fr 1fr 1fr; }
        .receipt-header { grid-template-columns: 48px 3fr 1fr 1fr 1fr; }
        .statement-header { grid-template-columns: 48px 1fr 3fr 1fr 1fr 1fr; }
        .thank-you-header { grid-template-columns: 48px 1fr 3fr 2fr 1fr 1fr; }


        .log-item {
            display: grid;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
        }
        .communication-item { grid-template-columns: 48px 2fr 1fr 1fr 1fr; }
        .receipt-item { grid-template-columns: 48px 3fr 1fr 1fr 1fr; }
        .statement-item { grid-template-columns: 48px 1fr 3fr 1fr 1fr 1fr; }
        .thank-you-item { grid-template-columns: 48px 1fr 3fr 2fr 1fr 1fr; }

        .log-item:hover {
            background-color: #4b5563; /* dark:hover:bg-gray-600 */
        }
        .log-icon {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin: 0 auto;
        }
        .log-content { flex-grow: 0; }

        /* Accordion styles for modal */
        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details .accordion-icon {
            transition: transform 0.2s;
        }
        details[open] .accordion-icon {
            transform: rotate(90deg);
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="communications-hub-content" class="flex flex-col h-full">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-700">
            <nav id="comm-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                <a href="#send" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Send
                </a>
                <a href="#communications" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-primary text-primary flex items-center gap-2">
                    <i class="fa-solid fa-comments"></i> Communications
                </a>
                <a href="#general-letters" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-file-lines"></i> General Letters
                </a>
                <a href="#receipts" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-receipt"></i> Receipts
                </a>
                <a href="#statements" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-file-invoice-dollar"></i> Statements
                </a>
                <a href="#thank-you-letters" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-pen-fancy"></i> Thank You Letters
                </a>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="flex-grow min-h-0">
            <!-- Send Email Tab -->
            <div id="send-tab-content" class="hidden h-full grid grid-cols-12 gap-4 p-4">
                <!-- Center Panel: Email Editor and Preview -->
                <div class="col-span-12 lg:col-span-9 flex flex-col gap-4">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-3 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <input type="text" placeholder="Email Subject..." class="filter-input w-full sm:w-auto flex-grow">
                        <div class="flex items-center gap-1 bg-gray-700 p-1 rounded-lg">
                            <button id="desktop-preview-btn" class="preview-btn active p-2 rounded-md transition"><i class="fa-solid fa-desktop"></i></button>
                            <button id="tablet-preview-btn" class="preview-btn p-2 rounded-md transition"><i class="fa-solid fa-tablet-screen-button"></i></button>
                            <button id="mobile-preview-btn" class="preview-btn p-2 rounded-md transition"><i class="fa-solid fa-mobile-screen-button"></i></button>
                        </div>
                    </div>
                    <div id="preview-wrapper" class="flex-grow bg-gray-700 rounded-lg flex justify-center p-4 overflow-auto">
                        <div id="email-canvas" class="bg-white dark:bg-gray-900 w-full shadow-lg transition-all duration-300" style="max-width: 800px;">
                            <p class="text-center text-gray-400 p-8">Start by selecting a template or dragging content here.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Toolbox, Templates, and Actions -->
                <div class="col-span-12 lg:col-span-3 flex flex-col gap-4">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                        <h4 class="font-semibold mb-3 text-lg">Mailing List</h4>
                        <select class="filter-input w-full mb-3">
                            <option>All Subscribers</option>
                            <option>Board Members</option>
                            <option>Volunteers</option>
                            <option>Major Donors</option>
                        </select>
                        <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition text-sm font-semibold">
                            <i class="fa-solid fa-plus mr-2"></i>Add New List
                        </button>
                    </div>

                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 flex-grow flex flex-col">
                        <div class="flex border-b border-gray-700 mb-4">
                            <button class="toolbox-tab-btn active flex-1 py-2 text-sm font-semibold border-b-2" data-tab="blocks">Content</button>
                            <button class="toolbox-tab-btn flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400" data-tab="templates">Templates</button>
                        </div>
                        <div class="flex-grow overflow-auto pr-2">
                            <div id="blocks-content" class="space-y-2">
                                <div class="toolbox-item" draggable="true" data-type="heading"><i class="fa-solid fa-heading mr-2"></i> Heading</div>
                                <div class="toolbox-item" draggable="true" data-type="text"><i class="fa-solid fa-paragraph mr-2"></i> Text</div>
                                <div class="toolbox-item" draggable="true" data-type="image"><i class="fa-solid fa-image mr-2"></i> Image</div>
                                <div class="toolbox-item" draggable="true" data-type="button"><i class="fa-solid fa-mouse-pointer mr-2"></i> Button</div>
                                <div class="toolbox-item" draggable="true" data-type="columns"><i class="fa-solid fa-columns mr-2"></i> Two Columns</div>
                                <div class="toolbox-item" draggable="true" data-type="divider"><i class="fa-solid fa-minus mr-2"></i> Divider</div>
                                <div class="toolbox-item" draggable="true" data-type="spacer"><i class="fa-solid fa-arrows-up-down mr-2"></i> Spacer</div>
                                <div class="toolbox-item" draggable="true" data-type="socials"><i class="fa-solid fa-share-nodes mr-2"></i> Social Links</div>
                            </div>
                            <div id="templates-content" class="hidden grid grid-cols-2 gap-2">
                                <div class="template-card" data-template="newsletter"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Newsletter" class="rounded-md mb-2" alt="Newsletter template preview"><h5 class="text-sm font-semibold">Newsletter</h5></div>
                                <div class="template-card" data-template="event"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Event" class="rounded-md mb-2" alt="Event template preview"><h5 class="text-sm font-semibold">Event Invite</h5></div>
                                <div class="template-card" data-template="appeal"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Appeal" class="rounded-md mb-2" alt="Appeal template preview"><h5 class="text-sm font-semibold">Donation Appeal</h5></div>
                                <div class="template-card" data-template="simple"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Simple" class="rounded-md mb-2" alt="Simple template preview"><h5 class="text-sm font-semibold">Announcement</h5></div>
                                <div class="template-card" data-template="welcome"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Welcome" class="rounded-md mb-2" alt="Welcome template preview"><h5 class="text-sm font-semibold">Welcome Email</h5></div>
                                <div class="template-card" data-template="impact"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Impact" class="rounded-md mb-2" alt="Impact template preview"><h5 class="text-sm font-semibold">Impact Report</h5></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 flex gap-4">
                         <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold">Preview</button>
                         <button class="w-full text-center py-2 px-4 rounded-lg bg-primary hover:bg-primary-hover transition font-semibold">Send Email</button>
                    </div>
                </div>
            </div>
            
            <!-- Communications Log Tab -->
            <div id="communications-tab-content" class="hidden h-full flex flex-col">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Communications Log</h3>
                    <button class="flex items-center bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary-hover transition duration-300 text-sm font-semibold">
                        <i class="fa-solid fa-plus mr-2"></i>Add Log
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="comm-search-input" placeholder="Search..." class="filter-input md:col-span-2">
                        <select id="comm-type-filter" class="filter-input">
                            <option value="all">All Types</option>
                            <option value="Email">Email</option>
                            <option value="Phone Call">Phone Call</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Mass Email">Mass Email</option>
                        </select>
                        <input type="date" id="comm-date-filter" class="filter-input">
                    </div>
                </div>
                <div class="list-header comm-list-header">
                    <div></div><div>Subject</div><div>Sender</div><div>Recipient</div><div class="text-right">Date</div>
                </div>
                <div id="comm-log-list" class="log-list-container flex-grow p-4"></div>
            </div>
            
            <div id="general-letters-tab-content" class="hidden h-full p-6"><h3 class="text-xl font-semibold">General Letters</h3><p class="text-gray-400 mt-4">Manage and create general letter templates here.</p></div>
            
            <!-- Other tab content divs remain unchanged -->
            <div id="receipts-tab-content" class="hidden h-full flex flex-col"><!-- ... --></div>
            <div id="statements-tab-content" class="hidden h-full flex flex-col"><!-- ... --></div>
            <div id="thank-you-letters-tab-content" class="hidden h-full flex flex-col"><!-- ... --></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // --- THEME SYNC WITH PARENT ---
                window.addEventListener('message', function(event) {
                    if (event.data.type === 'set-theme') {
                        const existingTheme = Array.from(document.body.classList).find(c => c.startsWith('theme-'));
                        if (existingTheme) document.body.classList.remove(existingTheme);
                        document.documentElement.className = event.data.mode;
                        document.body.classList.add(event.data.theme);
                    }
                });

                // --- TAB SWITCHING LOGIC ---
                const commTabsContainer = document.getElementById('comm-tabs');
                if (!commTabsContainer) {
                    console.error("Critical Error - Tab navigation container '#comm-tabs' not found.");
                    return;
                }
                const tabContents = document.querySelectorAll('[id$="-tab-content"]');
                const tabs = document.querySelectorAll('.comm-tab');

                const switchTab = (targetTab) => {
                    tabs.forEach(t => {
                        t.classList.remove('border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    targetTab.classList.add('border-primary', 'text-primary');
                    targetTab.classList.remove('border-transparent', 'text-gray-400');
                    
                    tabContents.forEach(content => content.classList.add('hidden'));
                    const targetContentId = targetTab.getAttribute('href').substring(1) + '-tab-content';
                    const targetContent = document.getElementById(targetContentId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    } else {
                        console.warn(`Tab content not found for ID: ${targetContentId}`);
                    }
                };
                
                commTabsContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    const clickedTab = e.target.closest('.comm-tab');
                    if (clickedTab) {
                        switchTab(clickedTab);
                    }
                });

                const initialActiveTab = document.querySelector('.comm-tab.text-primary') || tabs[1]; // Default to Communications
                if(initialActiveTab) {
                     switchTab(initialActiveTab);
                }


                // --- COMMUNICATIONS LOG LOGIC ---
                const commLogList = document.getElementById('comm-log-list');
                if (commLogList) {
                    const iconMap = {
                        'Email': { i: 'fa-envelope', c: 'blue' },
                        'Phone Call': { i: 'fa-phone', c: 'green' },
                        'Meeting': { i: 'fa-users', c: 'sky' },
                        'Mass Email': { i: 'fa-envelope-open-text', c: 'blue' }
                    };

                    const communicationData = [
                        {
                            id: 1, type: 'Email', subject: 'Follow-up on Gala Sponsorship',
                            preview: 'Hey Alex, just wanted to follow up on our conversation about sponsoring the annual gala...',
                            fullText: `<p>Hi Alex,</p><p>Hope you're having a great week.</p><p>I'm following up on our conversation from last week regarding the sponsorship opportunities for our annual gala. I've attached the sponsorship packet for your review, which details the different tiers and benefits.</p><p>We're really excited about the potential of partnering with Innovate Corp and would be happy to answer any questions you might have.</p><p>Best,</p><p>Jane Smith</p>`,
                            sender: 'Jane Smith', recipient: 'Alex Doe', date: '2025-08-22T11:45:00',
                            relatedAccounts: [{ name: 'Alex Doe', type: 'Primary Contact' }, { name: 'Innovate Corp', type: 'Organization' }],
                            attachments: [
                                { name: 'Gala_Sponsorship_Packet.pdf', size: '2.3 MB', type: 'pdf' },
                                { name: 'Event_Layout_v2.png', size: '850 KB', type: 'image' }
                            ],
                            audit: { createdBy: 'Jane Smith', createdDate: '2025-08-22T11:40:15Z', lastModifiedBy: 'Jane Smith', lastModifiedDate: '2025-08-22T11:45:00Z' }
                        },
                        {
                            id: 2, type: 'Phone Call', subject: 'Q3 Check-in with Anytown Foundation',
                            preview: 'Called to thank for recent pledge and discuss upcoming community project...',
                            fullText: `<p><strong>Call Summary:</strong></p><ul><li>Spoke with Michael Chen, Program Director.</li><li>Expressed gratitude for their recent $5,000 pledge.</li><li>Discussed our upcoming "Clean Parks Initiative" and their potential involvement as volunteers.</li><li>Michael seemed very interested and will discuss with his team.</li><li>Agreed to send a follow-up email with more details tomorrow.</li></ul>`,
                            sender: 'John Davis', recipient: 'Michael Chen', date: '2025-08-21T15:15:00',
                            relatedAccounts: [{ name: 'Michael Chen', type: 'Primary Contact' }, { name: 'Anytown Community Foundation', type: 'Organization' }],
                            attachments: [],
                            audit: { createdBy: 'John Davis', createdDate: '2025-08-21T15:10:30Z', lastModifiedBy: 'John Davis', lastModifiedDate: '2025-08-21T15:15:00Z' }
                        },
                        {
                            id: 3, type: 'Meeting', subject: 'Annual Review with Quantum Solutions',
                            preview: 'Met with the board to discuss grant impact and future collaboration...',
                            fullText: `<p><strong>Meeting Agenda:</strong></p><ol><li>Welcome & Introductions</li><li>Review of 2024 Grant Impact Report</li><li>Presentation on 2025 Strategic Goals</li><li>Discussion of Partnership Renewal</li><li>Q&A</li></ol><p><strong>Key Takeaways:</strong></p><p>The Quantum Solutions board was very pleased with the impact report. They have agreed in principle to renew their partnership for 2025 at the same level, with potential for an increase pending their Q4 budget approval.</p>`,
                            sender: 'Jane Smith', recipient: 'QS Board', date: '2025-08-20T09:30:00',
                            relatedAccounts: [{ name: 'Quantum Solutions', type: 'Organization' }, { name: 'Sarah Lee', type: 'Board Chair' }],
                            attachments: [{ name: '2024_Impact_Report.pptx', size: '12.1 MB', type: 'powerpoint' }],
                            audit: { createdBy: 'Jane Smith', createdDate: '2025-08-19T16:00:00Z', lastModifiedBy: 'Jane Smith', lastModifiedDate: '2025-08-20T11:00:00Z' }
                        }
                    ];
                    const searchInput = document.getElementById('comm-search-input');
                    const typeFilter = document.getElementById('comm-type-filter');
                    const dateFilter = document.getElementById('comm-date-filter');
                    
                    const renderCommunications = (data) => {
                        commLogList.innerHTML = '';
                        if (data.length === 0) { commLogList.innerHTML = '<p class="text-center text-gray-400 py-8">No communications found.</p>'; return; }
                        data.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'log-item communication-item';
                            itemEl.dataset.commId = item.id;
                            const icon = iconMap[item.type] || { i: 'fa-question-circle', c: 'gray' };
                            const date = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            itemEl.innerHTML = `<div class="log-icon bg-${icon.c}-100 text-${icon.c}-600 dark:bg-${icon.c}-900/50 dark:text-${icon.c}-400"><i class="fa-solid ${icon.i}"></i></div><div class="log-content"><p class="font-semibold">${item.subject}</p><p class="text-xs text-gray-400 truncate">${item.preview}</p></div><div class="text-sm text-gray-400">${item.sender}</div><div class="text-sm text-gray-400">${item.recipient}</div><div class="text-xs text-gray-400 text-right">${date}</div>`;
                            commLogList.appendChild(itemEl);
                        });
                    };

                    const createCommLogModalHTML = (log) => {
                        const logDate = new Date(log.date);
                        const formattedDate = logDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        const formattedTime = logDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        const formatAuditDate = (d) => new Date(d).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
                        const icon = iconMap[log.type] || { i: 'fa-question-circle', c: 'gray' };
                        
                        const fileIconMap = { pdf: 'fa-file-pdf', image: 'fa-file-image', powerpoint: 'fa-file-powerpoint', default: 'fa-file-alt' };

                        const attachmentsHTML = log.attachments.length > 0 ? `<div class="space-y-3">${log.attachments.map(f => `
                            <div class="flex items-center justify-between p-3 bg-gray-900/50 rounded-lg border border-gray-700 hover:border-primary/50 transition">
                                <div class="flex items-center gap-3"><i class="fa-solid ${fileIconMap[f.type] || fileIconMap.default} text-2xl text-gray-400"></i>
                                <div><p class="font-semibold text-gray-200">${f.name}</p><p class="text-xs text-gray-500">${f.size}</p></div></div>
                                <button class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-download"></i></button></div>`).join('')}</div>` : 
                                '<div class="text-center py-4 text-gray-500 text-sm">No files attached.</div>';

                        const relatedAccountsHTML = `<div class="space-y-1">${log.relatedAccounts.map(acc => `
                            <div class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-700/50">
                            <div class="w-8 h-8 rounded-full bg-primary/20 text-primary flex items-center justify-center font-bold text-sm flex-shrink-0">${acc.name.charAt(0)}</div>
                            <div><p class="font-semibold text-sm text-gray-200">${acc.name}</p><p class="text-xs text-gray-400">${acc.type}</p></div></div>`).join('')}</div>`;

                        const auditHTML = `<div class="p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                            <ul class="space-y-2 text-sm text-gray-400">
                                <li class="flex justify-between"><span>Created By:</span><span class="font-medium text-gray-300">${log.audit.createdBy}</span></li>
                                <li class="flex justify-between"><span>Created Date:</span><span class="font-medium text-gray-300">${formatAuditDate(log.audit.createdDate)}</span></li>
                                <li class="flex justify-between"><span>Last Modified By:</span><span class="font-medium text-gray-300">${log.audit.lastModifiedBy}</span></li>
                                <li class="flex justify-between"><span>Last Modified Date:</span><span class="font-medium text-gray-300">${formatAuditDate(log.audit.lastModifiedDate)}</span></li>
                            </ul></div>`;
                        
                        return `
                        <div class="max-h-[85vh] overflow-y-auto pr-2">
                           <div class="space-y-6 pr-4">
                                <!-- Header Section -->
                                <div class="flex items-center gap-4">
                                    <div class="log-icon bg-${icon.c}-100 text-${icon.c}-600 dark:bg-${icon.c}-900/50 dark:text-${icon.c}-400 !w-12 !h-12 text-xl flex-shrink-0"><i class="fa-solid ${icon.i}"></i></div>
                                    <div>
                                        <h3 class="text-xl font-bold text-white">${log.subject}</h3>
                                        <p class="text-sm text-gray-400">From: <span class="font-medium text-gray-300">${log.sender}</span>  To: <span class="font-medium text-gray-300">${log.recipient}</span></p>
                                    </div>
                                </div>
                                <!-- Details Section -->
                                <div class="border-t border-b border-gray-700 py-4">
                                     <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2">
                                        <div class="text-center md:text-left"><span class="text-xs text-gray-400">Method</span><p class="font-semibold text-gray-200 text-sm">${log.type}</p></div>
                                        <div class="text-center md:text-left"><span class="text-xs text-gray-400">Date</span><p class="font-semibold text-gray-200 text-sm">${formattedDate}</p></div>
                                        <div class="text-center md:text-left"><span class="text-xs text-gray-400">Time</span><p class="font-semibold text-gray-200 text-sm">${formattedTime}</p></div>
                                        <div class="text-center md:text-left"><span class="text-xs text-gray-400">Log ID</span><p class="font-mono text-gray-200 text-sm">${log.id}</p></div>
                                     </div>
                                </div>
                                <!-- Main Content -->
                                <div class="space-y-6">
                                    <div>
                                        <h4 class="font-semibold text-gray-200 mb-2 text-sm uppercase tracking-wider">Communication</h4>
                                        <div class="text-gray-300 space-y-3 leading-relaxed p-4 bg-gray-900/50 rounded-lg border border-gray-700 min-h-[200px]">${log.fullText}</div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-200 mb-2 text-sm uppercase tracking-wider">Attachments (${log.attachments.length})</h4>
                                        ${attachmentsHTML}
                                    </div>
                                </div>
                                 <!-- Footer Accordions -->
                                <div class="border-t border-gray-700 pt-6 space-y-4">
                                     <details class="border border-gray-700 rounded-lg bg-gray-800/50"><summary class="p-3 flex justify-between items-center font-semibold text-gray-200 text-sm uppercase tracking-wider hover:bg-gray-700/50 rounded-t-lg"><div class="flex items-center gap-2"><i class="fa-solid fa-users"></i> Related Accounts</div><i class="fa-solid fa-chevron-right accordion-icon"></i></summary><div class="p-4 border-t border-gray-700">${relatedAccountsHTML}</div></details>
                                     <details class="border border-gray-700 rounded-lg bg-gray-800/50"><summary class="p-3 flex justify-between items-center font-semibold text-gray-200 text-sm uppercase tracking-wider hover:bg-gray-700/50 rounded-t-lg"><div class="flex items-center gap-2"><i class="fa-solid fa-info-circle"></i> Audit Information</div><i class="fa-solid fa-chevron-right accordion-icon"></i></summary><div class="p-4 border-t border-gray-700">${auditHTML}</div></details>
                                </div>
                            </div>
                        </div>
                        `;
                    };

                    const filterAndRender = () => {
                        const s = searchInput.value.toLowerCase(), t = typeFilter.value, d = dateFilter.value;
                        const filtered = communicationData.filter(i => (i.subject.toLowerCase().includes(s) || i.recipient.toLowerCase().includes(s) || i.sender.toLowerCase().includes(s)) && (t === 'all' || i.type === t) && (!d || i.date.startsWith(d)));
                        renderCommunications(filtered);
                    };

                    [searchInput, typeFilter, dateFilter].forEach(el => el.addEventListener('input', filterAndRender));
                    
                    document.getElementById('communications-tab-content').addEventListener('click', (e) => {
                        const item = e.target.closest('.communication-item');
                        if (item && typeof window.parent.showAppModal === 'function') {
                            const commId = parseInt(item.dataset.commId, 10);
                            const logData = communicationData.find(log => log.id === commId);
                            if (logData) {
                                // Pass an empty string for the title to remove the header
                                // Using a combination of classes to force a wide aspect ratio
                                window.parent.showAppModal('', createCommLogModalHTML(logData), 'max-w-none w-[80vw]');
                            }
                        }
                    });
                    
                    renderCommunications(communicationData);
                }

                // --- OTHER TAB LOGIC (RECEIPTS, STATEMENTS, ETC.) WOULD GO HERE, UNCHANGED ---
            
            } catch (error) {
                console.error("Communications.js: An unexpected error occurred:", error);
            }
        });
    </script>
</body>
</html>

