<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communications Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* --- Base Theme Variables --- */
        :root {
            --color-primary: 217 91% 60%;
            --color-primary-hover: 217 91% 55%;
            --color-primary-foreground: 210 40% 98%;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Dynamic styles for theme colors */
        .text-primary { color: hsl(var(--color-primary)); }
        .bg-primary { background-color: hsl(var(--color-primary)); }
        .bg-primary-hover:hover { background-color: hsl(var(--color-primary-hover)); }
        .text-primary-foreground { color: hsl(var(--color-primary-foreground)); }
        .border-primary { border-color: hsl(var(--color-primary)); }
        .ring-primary { ring-color: hsl(var(--color-primary)); }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; border: 3px solid transparent; }
        
        /* --- General Inputs --- */
        .filter-input {
            width: 100%;
            background-color: #1f2937; /* dark:bg-gray-900 -> bg-gray-800 in real app but this is iframe */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: #d1d5db; /* dark:text-gray-300 */
        }
        
        /* --- Email Builder Specific --- */
        .preview-btn.active { background-color: hsl(var(--color-primary)); color: hsl(var(--color-primary-foreground)); }
        .toolbox-tab-btn.active { border-color: hsl(var(--color-primary)); color: hsl(var(--color-primary)); }
        .template-card { cursor: pointer; transition: transform 0.2s; }
        .template-card:hover { transform: scale(1.05); }
        .toolbox-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
            cursor: grab;
            transition: background-color 0.2s;
        }
        .toolbox-item:hover {
             background-color: #4b5563; /* dark:bg-gray-600 */
        }


        /* --- Log/List Styles (Used by Comms, Receipts & Statements) --- */
        .log-list-container {
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
        }
        .list-header {
            display: grid;
            gap: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af; /* gray-400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            align-items: center;
        }
        .comm-list-header { grid-template-columns: 48px 2fr 1fr 1fr 1fr; }
        .receipt-header { grid-template-columns: 48px 3fr 1fr 1fr 1fr; }
        .statement-header { grid-template-columns: 48px 1fr 3fr 1fr 1fr 1fr; }
        .thank-you-header { grid-template-columns: 48px 1fr 3fr 2fr 1fr 1fr; }


        .log-item {
            display: grid;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            background-color: #374151; /* dark:bg-gray-700 */
            border: 1px solid #4b5563; /* dark:border-gray-600 */
        }
        .communication-item { grid-template-columns: 48px 2fr 1fr 1fr 1fr; }
        .receipt-item { grid-template-columns: 48px 3fr 1fr 1fr 1fr; }
        .statement-item { grid-template-columns: 48px 1fr 3fr 1fr 1fr 1fr; }
        .thank-you-item { grid-template-columns: 48px 1fr 3fr 2fr 1fr 1fr; }

        .log-item:hover {
            background-color: #4b5563; /* dark:hover:bg-gray-600 */
        }
        .log-icon {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin: 0 auto;
        }
        .log-content { flex-grow: 0; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="communications-hub-content" class="flex flex-col h-full">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-700">
            <nav id="comm-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                <a href="#send" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-primary text-primary flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Send
                </a>
                <a href="#communications" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-comments"></i> Communications
                </a>
                <a href="#general-letters" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-file-lines"></i> General Letters
                </a>
                <a href="#receipts" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-receipt"></i> Receipts
                </a>
                <a href="#statements" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-file-invoice-dollar"></i> Statements
                </a>
                <a href="#thank-you-letters" class="comm-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-500 flex items-center gap-2">
                    <i class="fa-solid fa-pen-fancy"></i> Thank You Letters
                </a>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="flex-grow min-h-0">
            <!-- Send Email Tab -->
            <div id="send-tab-content" class="hidden h-full grid grid-cols-12 gap-4 p-4">
                <!-- Center Panel: Email Editor and Preview -->
                <div class="col-span-12 lg:col-span-9 flex flex-col gap-4">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-3 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <input type="text" placeholder="Email Subject..." class="filter-input w-full sm:w-auto flex-grow">
                        <div class="flex items-center gap-1 bg-gray-700 p-1 rounded-lg">
                            <button id="desktop-preview-btn" class="preview-btn active p-2 rounded-md transition"><i class="fa-solid fa-desktop"></i></button>
                            <button id="tablet-preview-btn" class="preview-btn p-2 rounded-md transition"><i class="fa-solid fa-tablet-screen-button"></i></button>
                            <button id="mobile-preview-btn" class="preview-btn p-2 rounded-md transition"><i class="fa-solid fa-mobile-screen-button"></i></button>
                        </div>
                    </div>
                    <div id="preview-wrapper" class="flex-grow bg-gray-700 rounded-lg flex justify-center p-4 overflow-auto">
                        <div id="email-canvas" class="bg-white dark:bg-gray-900 w-full shadow-lg transition-all duration-300" style="max-width: 800px;">
                            <p class="text-center text-gray-400 p-8">Start by selecting a template or dragging content here.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Toolbox, Templates, and Actions -->
                <div class="col-span-12 lg:col-span-3 flex flex-col gap-4">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                        <h4 class="font-semibold mb-3 text-lg">Mailing List</h4>
                        <select class="filter-input w-full mb-3">
                            <option>All Subscribers</option>
                            <option>Board Members</option>
                            <option>Volunteers</option>
                            <option>Major Donors</option>
                        </select>
                        <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition text-sm font-semibold">
                            <i class="fa-solid fa-plus mr-2"></i>Add New List
                        </button>
                    </div>

                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 flex-grow flex flex-col">
                        <div class="flex border-b border-gray-700 mb-4">
                            <button class="toolbox-tab-btn active flex-1 py-2 text-sm font-semibold border-b-2" data-tab="blocks">Content</button>
                            <button class="toolbox-tab-btn flex-1 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400" data-tab="templates">Templates</button>
                        </div>
                        <div class="flex-grow overflow-auto pr-2">
                            <div id="blocks-content" class="space-y-2">
                                <div class="toolbox-item" draggable="true" data-type="heading"><i class="fa-solid fa-heading mr-2"></i> Heading</div>
                                <div class="toolbox-item" draggable="true" data-type="text"><i class="fa-solid fa-paragraph mr-2"></i> Text</div>
                                <div class="toolbox-item" draggable="true" data-type="image"><i class="fa-solid fa-image mr-2"></i> Image</div>
                                <div class="toolbox-item" draggable="true" data-type="button"><i class="fa-solid fa-mouse-pointer mr-2"></i> Button</div>
                                <div class="toolbox-item" draggable="true" data-type="columns"><i class="fa-solid fa-columns mr-2"></i> Two Columns</div>
                                <div class="toolbox-item" draggable="true" data-type="divider"><i class="fa-solid fa-minus mr-2"></i> Divider</div>
                                <div class="toolbox-item" draggable="true" data-type="spacer"><i class="fa-solid fa-arrows-up-down mr-2"></i> Spacer</div>
                                <div class="toolbox-item" draggable="true" data-type="socials"><i class="fa-solid fa-share-nodes mr-2"></i> Social Links</div>
                            </div>
                            <div id="templates-content" class="hidden grid grid-cols-2 gap-2">
                                <div class="template-card" data-template="newsletter"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Newsletter" class="rounded-md mb-2"><h5 class="text-sm font-semibold">Newsletter</h5></div>
                                <div class="template-card" data-template="event"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Event" class="rounded-md mb-2"><h5 class="text-sm font-semibold">Event Invite</h5></div>
                                <div class="template-card" data-template="appeal"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Appeal" class="rounded-md mb-2"><h5 class="text-sm font-semibold">Donation Appeal</h5></div>
                                <div class="template-card" data-template="simple"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Simple" class="rounded-md mb-2"><h5 class="text-sm font-semibold">Announcement</h5></div>
                                <div class="template-card" data-template="welcome"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Welcome" class="rounded-md mb-2"><h5 class="text-sm font-semibold">Welcome Email</h5></div>
                                <div class="template-card" data-template="impact"><img src="https://placehold.co/200x150/6b7280/ffffff?text=Impact" class="rounded-md mb-2"><h5 class="text-sm font-semibold">Impact Report</h5></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 flex gap-4">
                         <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold">Preview</button>
                         <button class="w-full text-center py-2 px-4 rounded-lg bg-primary hover:bg-primary-hover transition font-semibold">Send Email</button>
                    </div>
                </div>
            </div>
            
            <!-- Communications Log Tab -->
            <div id="communications-tab-content" class="hidden h-full flex flex-col">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Communications Log</h3>
                    <button class="flex items-center bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary-hover transition duration-300 text-sm font-semibold">
                        <i class="fa-solid fa-plus mr-2"></i>Add Log
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="comm-search-input" placeholder="Search..." class="filter-input md:col-span-2">
                        <select id="comm-type-filter" class="filter-input">
                            <option value="all">All Types</option>
                            <option value="Email">Email</option>
                            <option value="Phone Call">Phone Call</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Mass Email">Mass Email</option>
                        </select>
                        <input type="date" id="comm-date-filter" class="filter-input">
                    </div>
                </div>
                <div class="list-header comm-list-header">
                    <div></div><div>Subject</div><div>Sender</div><div>Recipient</div><div class="text-right">Date</div>
                </div>
                <div id="comm-log-list" class="log-list-container flex-grow p-4"></div>
            </div>
            
            <div id="general-letters-tab-content" class="hidden h-full p-6"><h3 class="text-xl font-semibold">General Letters</h3><p class="text-gray-400 mt-4">Manage and create general letter templates here.</p></div>
            
            <!-- Receipts Tab -->
            <div id="receipts-tab-content" class="hidden h-full flex flex-col">
                 <div class="p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-semibold">Donation Receipts</h3>
                    <button class="flex items-center bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary-hover transition duration-300 text-sm font-semibold">
                        <i class="fa-solid fa-cogs mr-2"></i>Generate Receipts
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700 shrink-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="receipt-search-input" placeholder="Search by name or receipt #" class="filter-input md:col-span-2">
                        <select id="receipt-year-filter" class="filter-input">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="list-header receipt-header shrink-0">
                    <div></div>
                    <div>Recipient</div>
                    <div>Receipt #</div>
                    <div class="text-right">Amount</div>
                    <div class="text-right">Date</div>
                </div>
                <div id="receipt-log-list" class="log-list-container flex-grow p-4">
                    <!-- Receipt items will be rendered here by JS -->
                </div>
            </div>

            <!-- Statements Tab -->
            <div id="statements-tab-content" class="hidden h-full flex flex-col">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-semibold">Account Statements</h3>
                    <button class="flex items-center bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary-hover transition duration-300 text-sm font-semibold">
                        <i class="fa-solid fa-cogs mr-2"></i>Generate Statements
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700 shrink-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="statement-search-input" placeholder="Search by name or job #" class="filter-input md:col-span-2">
                        <select id="statement-status-filter" class="filter-input">
                           <option value="all">All Statuses</option>
                           <option value="paid">Paid</option>
                           <option value="pending">Pending</option>
                           <option value="overdue">Overdue</option>
                           <option value="void">Void</option>
                        </select>
                    </div>
                </div>
                <div class="list-header statement-header shrink-0">
                    <div></div>
                    <div>Job #</div>
                    <div>Recipient</div>
                    <div class="text-right">Pledge</div>
                    <div class="text-right">Balance</div>
                    <div class="text-right">Stmt Date</div>
                </div>
                <div id="statement-log-list" class="log-list-container flex-grow p-4">
                    <!-- Statement items will be rendered here by JS -->
                </div>
            </div>

            <!-- Thank You Letters Tab -->
            <div id="thank-you-letters-tab-content" class="hidden h-full flex flex-col">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-lg font-semibold">Thank You Letters</h3>
                    <button class="flex items-center bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary-hover transition duration-300 text-sm font-semibold">
                        <i class="fa-solid fa-plus mr-2"></i>Create Letters
                    </button>
                </div>
                <div class="p-4 border-b border-gray-700 shrink-0">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="thank-you-search-input" placeholder="Search by name or job #" class="filter-input md:col-span-2">
                        <select id="thank-you-status-filter" class="filter-input">
                           <option value="all">All Statuses</option>
                           <option value="Downloaded">Downloaded</option>
                           <option value="Pending">Pending</option>
                        </select>
                    </div>
                </div>
                <div class="list-header thank-you-header shrink-0">
                    <div></div>
                    <div>Job #</div>
                    <div>Thanked Account</div>
                    <div>Letter Code</div>
                    <div class="text-right">Pledge</div>
                    <div class="text-right">Create Date</div>
                </div>
                <div id="thank-you-log-list" class="log-list-container flex-grow p-4">
                    <!-- Thank You Letter items will be rendered here by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // --- THEME SYNC WITH PARENT ---
                window.addEventListener('message', function(event) {
                    if (event.data.type === 'set-theme') {
                        const existingTheme = Array.from(document.body.classList).find(c => c.startsWith('theme-'));
                        if (existingTheme) document.body.classList.remove(existingTheme);
                        document.documentElement.className = event.data.mode;
                        document.body.classList.add(event.data.theme);
                    }
                });

                // --- TAB SWITCHING LOGIC ---
                const commTabsContainer = document.getElementById('comm-tabs');
                if (!commTabsContainer) {
                    console.error("Critical Error - Tab navigation container '#comm-tabs' not found.");
                    return;
                }
                const tabContents = document.querySelectorAll('[id$="-tab-content"]');
                const tabs = document.querySelectorAll('.comm-tab');

                const switchTab = (targetTab) => {
                    tabs.forEach(t => {
                        t.classList.remove('border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    targetTab.classList.add('border-primary', 'text-primary');
                    targetTab.classList.remove('border-transparent', 'text-gray-400');
                    
                    tabContents.forEach(content => content.classList.add('hidden'));
                    const targetContentId = targetTab.getAttribute('href').substring(1) + '-tab-content';
                    const targetContent = document.getElementById(targetContentId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    } else {
                        console.warn(`Tab content not found for ID: ${targetContentId}`);
                    }
                };
                
                commTabsContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    const clickedTab = e.target.closest('.comm-tab');
                    if (clickedTab) {
                        switchTab(clickedTab);
                    }
                });

                const initialActiveTab = document.querySelector('.comm-tab.text-primary');
                if(initialActiveTab) {
                     switchTab(initialActiveTab);
                } else if(tabs.length > 0) {
                     switchTab(tabs[0]);
                }

                // --- EMAIL BUILDER LOGIC ---
                const emailCanvas = document.getElementById('email-canvas');
                if (emailCanvas) {
                    // Preview Buttons
                    const desktopBtn = document.getElementById('desktop-preview-btn');
                    const tabletBtn = document.getElementById('tablet-preview-btn');
                    const mobileBtn = document.getElementById('mobile-preview-btn');
                    const previewBtns = [desktopBtn, tabletBtn, mobileBtn];

                    const setPreviewSize = (size) => {
                        previewBtns.forEach(btn => btn.classList.remove('active'));
                        if (size === 'desktop') {
                            emailCanvas.style.maxWidth = '800px';
                            desktopBtn.classList.add('active');
                        } else if (size === 'tablet') {
                            emailCanvas.style.maxWidth = '600px';
                            tabletBtn.classList.add('active');
                        } else {
                            emailCanvas.style.maxWidth = '375px';
                            mobileBtn.classList.add('active');
                        }
                    };
                    desktopBtn.addEventListener('click', () => setPreviewSize('desktop'));
                    tabletBtn.addEventListener('click', () => setPreviewSize('tablet'));
                    mobileBtn.addEventListener('click', () => setPreviewSize('mobile'));

                    // Toolbox Tabs (Content/Templates)
                    const toolboxTabBtns = document.querySelectorAll('.toolbox-tab-btn');
                    const blocksContent = document.getElementById('blocks-content');
                    const templatesContent = document.getElementById('templates-content');
                    toolboxTabBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            toolboxTabBtns.forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            blocksContent.classList.toggle('hidden', btn.dataset.tab !== 'blocks');
                            templatesContent.classList.toggle('hidden', btn.dataset.tab !== 'templates');
                        });
                    });
                }
                
                // --- COMMUNICATIONS LOG LOGIC ---
                const commLogList = document.getElementById('comm-log-list');
                if (commLogList) {
                    const communicationData = [
                        { type: 'Email', subject: 'Follow-up on Gala', preview: 'Hey Alex, just wanted to follow up...', fullText: 'Full email text here...', sender: 'Jane Smith', recipient: 'Alex Doe', date: '2025-08-22T11:45:00' },
                        { type: 'Phone Call', subject: 'Q3 Check-in with Innovate Corp', preview: 'Called to thank for recent pledge...', fullText: 'Full phone call summary...', sender: 'John Davis', recipient: 'Innovate Corp', date: '2025-08-21T15:15:00' },
                        { type: 'Meeting', subject: 'Anytown Community Foundation', preview: 'Met with the board to discuss grant...', fullText: 'Full meeting notes...', sender: 'Jane Smith', recipient: 'ACF Board', date: '2025-08-20T09:30:00' },
                    ];
                    const searchInput = document.getElementById('comm-search-input');
                    const typeFilter = document.getElementById('comm-type-filter');
                    const dateFilter = document.getElementById('comm-date-filter');
                    
                    const renderCommunications = (data) => {
                        commLogList.innerHTML = '';
                        if (data.length === 0) { commLogList.innerHTML = '<p class="text-center text-gray-400">No communications found.</p>'; return; }
                        data.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'log-item communication-item';
                            const iconMap = { 'Email': { i: 'fa-envelope', c: 'blue' }, 'Phone Call': { i: 'fa-phone', c: 'green' }, 'Meeting': { i: 'fa-users', c: 'sky' }, 'Mass Email': { i: 'fa-envelope-open-text', c: 'blue' } };
                            const icon = iconMap[item.type] || { i: 'fa-question-circle', c: 'gray' };
                            const date = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            itemEl.innerHTML = `<div class="log-icon bg-${icon.c}-100 text-${icon.c}-600 dark:bg-${icon.c}-900/50 dark:text-${icon.c}-400"><i class="fa-solid ${icon.i}"></i></div><div class="log-content"><p class="font-semibold">${item.subject}</p><p class="text-xs text-gray-400 truncate">${item.preview}</p></div><div class="text-sm text-gray-400">${item.sender}</div><div class="text-sm text-gray-400">${item.recipient}</div><div class="text-xs text-gray-400 text-right">${date}</div><div class="log-full-content hidden">${item.fullText}</div>`;
                            commLogList.appendChild(itemEl);
                        });
                    };

                    const filterAndRender = () => {
                        const s = searchInput.value.toLowerCase(), t = typeFilter.value, d = dateFilter.value;
                        const filtered = communicationData.filter(i => (i.subject.toLowerCase().includes(s) || i.recipient.toLowerCase().includes(s) || i.sender.toLowerCase().includes(s)) && (t === 'all' || i.type === t) && (!d || i.date.startsWith(d)));
                        renderCommunications(filtered);
                    };

                    [searchInput, typeFilter, dateFilter].forEach(el => el.addEventListener('input', filterAndRender));
                    document.getElementById('communications-tab-content').addEventListener('click', (e) => {
                        const item = e.target.closest('.communication-item');
                        if (item && typeof window.parent.showAppModal === 'function') {
                            window.parent.showAppModal(item.querySelector('.font-semibold').textContent, `<p>${item.querySelector('.log-full-content').innerHTML}</p>`);
                        }
                    });
                    renderCommunications(communicationData);
                }

                // --- RECEIPTS LOGIC ---
                const receiptLogList = document.getElementById('receipt-log-list');
                if (receiptLogList) {
                    const receiptData = [
                        { id: 724, name: 'Quantum Solutions', org: 'Corporate Partner', date: '2025-08-15', year: 2025, amount: 6000.00, status: 'Issued', address: '400 Esna Park Road<br>Markham ON U.S.A.', payments: [{ date: '2025-07-15', trans: 12124, type: 'Visa', amount: 3000.00 }, { date: '2025-08-15', trans: 11578, type: 'Visa', amount: 3000.00 }] },
                        { id: 70, name: 'Garcia, Sofia', org: 'Individual', date: '2024-07-31', year: 2024, amount: 1000.00, status: 'Issued', address: 'PO Box 8<br>Anytown, PA 15003', payments: [{ date: '2024-07-30', trans: 8901, type: 'Check', amount: 1000.00 }] },
                        { id: 69, name: 'Chen, Wei', org: 'Individual', date: '2025-01-31', year: 2025, amount: 2500.00, status: 'Issued', address: 'Mailing Address<br>Anytown, PA 15003', payments: [{ date: '2025-01-25', trans: 7812, type: 'Stock', amount: 2500.00 }] },
                        { id: 68, name: 'American Bearings Manufacturing Ltd.', org: 'Corporate Partner', date: '2024-08-01', year: 2024, amount: 3500.00, status: 'Void', address: 'PO Box 8<br>Anytown, PA 15003', payments: [] },
                    ];
                    const searchInput = document.getElementById('receipt-search-input');
                    const yearFilter = document.getElementById('receipt-year-filter');

                    const populateYearFilter = () => {
                        const years = [...new Set(receiptData.map(r => r.year))].sort((a, b) => b - a);
                        yearFilter.innerHTML = '<option value="all">All Campaign Years</option>';
                        years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearFilter.appendChild(option);
                        });
                    };

                    const renderReceipts = (data) => {
                        receiptLogList.innerHTML = '';
                        if (data.length === 0) {
                            receiptLogList.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">No receipts found matching your criteria.</p>';
                            return;
                        }
                        data.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'log-item receipt-item';
                            itemEl.dataset.receiptId = item.id;
                            const statusMap = { 'Issued': { i: 'fa-check-circle', c: 'green' }, 'Pending': { i: 'fa-clock', c: 'yellow' }, 'Void': { i: 'fa-times-circle', c: 'red' } };
                            const icon = statusMap[item.status] || { i: 'fa-question-circle', c: 'gray' };
                            itemEl.innerHTML = `
                                <div class="log-icon bg-${icon.c}-100 text-${icon.c}-600 dark:bg-${icon.c}-900/50 dark:text-${icon.c}-400"><i class="fa-solid ${icon.i}"></i></div>
                                <div class="log-content"><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-400 truncate">${item.org || 'Individual'}</p></div>
                                <div class="text-sm text-gray-400 font-mono">${item.id}</div>
                                <div class="text-sm text-gray-400 text-right font-semibold">${item.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                <div class="text-xs text-gray-400 text-right">${new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>`;
                            receiptLogList.appendChild(itemEl);
                        });
                    };
                    
                    const createReceiptModalHTML = (receipt) => {
                         let paymentsHTML = receipt.payments.map(p => `
                            <tr class="border-b border-gray-700 last:border-b-0">
                                <td class="py-2 px-2 text-xs">${new Date(p.date).toLocaleDateString('en-US')}</td>
                                <td class="py-2 px-2 text-xs font-mono">${p.trans}</td>
                                <td class="py-2 px-2 text-xs">${p.type}</td>
                                <td class="py-2 px-2 text-sm text-right font-semibold">${p.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                            </tr>
                        `).join('');

                        if (receipt.payments.length === 0) {
                            paymentsHTML = '<tr><td colspan="4" class="text-center py-4 text-sm text-gray-400">No payment details for this receipt.</td></tr>';
                        }

                        return `
                            <div class="space-y-6">
                                <div>
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="text-sm text-gray-400">Recipient</p>
                                            <p class="font-bold text-lg">${receipt.name}</p>
                                            <p class="text-sm text-gray-300">${receipt.address}</p>
                                        </div>
                                        <div class="text-right flex-shrink-0 ml-4">
                                             <p class="text-sm text-gray-400">Total Amount</p>
                                             <p class="font-bold text-2xl text-primary">${receipt.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-md mb-2">Payment Details</h4>
                                    <div class="bg-gray-900/50 rounded-lg border border-gray-700 overflow-hidden">
                                        <table class="w-full">
                                            <thead class="bg-gray-700/50">
                                                <tr>
                                                    <th class="py-2 px-2 text-left text-xs font-semibold uppercase tracking-wider">Date</th>
                                                    <th class="py-2 px-2 text-left text-xs font-semibold uppercase tracking-wider">Trans #</th>
                                                    <th class="py-2 px-2 text-left text-xs font-semibold uppercase tracking-wider">Type</th>
                                                    <th class="py-2 px-2 text-right text-xs font-semibold uppercase tracking-wider">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>${paymentsHTML}</tbody>
                                        </table>
                                    </div>
                                </div>
                                 <div class="flex gap-4 pt-4 border-t border-gray-700">
                                    <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold"><i class="fa-solid fa-print mr-2"></i>Print</button>
                                    <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold"><i class="fa-solid fa-copy mr-2"></i>Duplicate Receipt</button>
                                </div>
                            </div>
                        `;
                    };

                    const filterAndRenderReceipts = () => {
                        const searchTerm = searchInput.value.toLowerCase();
                        const selectedYear = yearFilter.value;
                        const filtered = receiptData.filter(item => {
                            const nameMatch = item.name.toLowerCase().includes(searchTerm);
                            const idMatch = item.id.toString().includes(searchTerm);
                            const yearMatch = (selectedYear === 'all' || item.year == selectedYear);
                            return (nameMatch || idMatch) && yearMatch;
                        });
                        renderReceipts(filtered);
                    };

                    [searchInput, yearFilter].forEach(el => el.addEventListener('input', filterAndRenderReceipts));
                    receiptLogList.addEventListener('click', (e) => {
                        const item = e.target.closest('.receipt-item');
                        if (item && typeof window.parent.showAppModal === 'function') {
                            const receiptId = parseInt(item.dataset.receiptId, 10);
                            const receipt = receiptData.find(r => r.id === receiptId);
                            if (receipt) {
                                window.parent.showAppModal(`Receipt Details: #${receipt.id}`, createReceiptModalHTML(receipt));
                            }
                        }
                    });

                    populateYearFilter();
                    filterAndRenderReceipts();
                }

                // --- STATEMENTS LOGIC ---
                const statementLogList = document.getElementById('statement-log-list');
                if(statementLogList) {
                    const statementData = [
                        { id: 5326, date: '2025-09-01', dueDate: '2025-08-15', recipient: 'Martinez, Carlos', address: 'PO Box 8475<br>Toronto ON Canada T3S 4C5', pledge: 2500.00, paid: 1800.00, balance: 700.00, status: 'issued', details: [{ year: 2025, type: 'Employee To Be Billed', pledge: 2500.00, paid: 1800.00, balance: 700.00, currentDue: 208.33, pastDue: 491.67 }] },
                        { id: 3672, date: '2025-08-10', dueDate: '2025-10-01', recipient: 'Okafor, Chidi', address: 'PO Box 8475<br>Toronto ON Canada T3S 4C5', pledge: 600.00, paid: 500.00, balance: 100.00, status: 'issued', details: [{ year: 2025, type: 'Employee To Be Billed', pledge: 600.00, paid: 500.00, balance: 100.00, currentDue: 50.00, pastDue: 0.00 }] },
                        { id: 2685, date: '2024-06-25', dueDate: null, recipient: 'Apex Construction', address: '123 Main St<br>Anytown, USA', pledge: 1200.00, paid: 600.00, balance: 600.00, status: 'void', details: [] },
                        { id: 7623, date: '2025-08-21', dueDate: null, recipient: 'Kim, Sun-hee', address: 'PO Box 8475<br>Toronto ON Canada T3S 4C5', pledge: 5000.00, paid: 5000.00, balance: 0.00, status: 'issued', details: [{ year: 2025, type: 'Standard Pledge', pledge: 5000.00, paid: 5000.00, balance: 0.00, currentDue: 0.00, pastDue: 0.00 }] },
                        { id: 9688, date: '2024-10-12', dueDate: '2024-09-30', recipient: 'Williams, Aisha', address: 'PO Box 8475<br>Toronto ON Canada T3S 4C5', pledge: 5000.00, paid: 3700.00, balance: 1300.00, status: 'issued', details: [{ year: 2024, type: 'Standard Pledge', pledge: 5000.00, paid: 3700.00, balance: 1300.00, currentDue: 0.00, pastDue: 1300.00 }] },
                    ];
                    const searchInput = document.getElementById('statement-search-input');
                    const statusFilter = document.getElementById('statement-status-filter');

                    const renderStatements = (data) => {
                        statementLogList.innerHTML = '';
                        if (data.length === 0) {
                            statementLogList.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">No statements found matching your criteria.</p>';
                            return;
                        }
                        data.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'log-item statement-item';
                            itemEl.dataset.statementId = item.id;
                            
                            let icon;
                            const now = new Date();
                            if (item.status === 'void') {
                                icon = { i: 'fa-times-circle', c: 'red', status: 'void' };
                            } else if (item.balance <= 0) {
                                icon = { i: 'fa-check-circle', c: 'green', status: 'paid' };
                            } else if (item.dueDate && new Date(item.dueDate) < now) {
                                icon = { i: 'fa-exclamation-circle', c: 'red', status: 'overdue' };
                            } else {
                                icon = { i: 'fa-clock', c: 'yellow', status: 'pending' };
                            }
                            item.currentStatus = icon.status;

                            itemEl.innerHTML = `
                                <div class="log-icon bg-${icon.c}-100 text-${icon.c}-600 dark:bg-${icon.c}-900/50 dark:text-${icon.c}-400"><i class="fa-solid ${icon.i}"></i></div>
                                <div class="text-sm text-gray-400 font-mono">${item.id}</div>
                                <div class="log-content"><p class="font-semibold">${item.recipient}</p></div>
                                <div class="text-sm text-gray-400 text-right font-semibold">${item.pledge.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                <div class="text-sm text-gray-400 text-right font-semibold">${item.balance.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                <div class="text-xs text-gray-400 text-right">${new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                            `;
                            statementLogList.appendChild(itemEl);
                        });
                    };

                    const createStatementModalHTML = (stmt) => {
                        let detailsHTML = stmt.details.map(d => `
                            <tr class="border-b border-gray-700 last:border-b-0">
                                <td class="p-2 text-xs">${d.year}</td>
                                <td class="p-2 text-xs">${d.type}</td>
                                <td class="p-2 text-xs text-right">${d.pledge.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                <td class="p-2 text-xs text-right">${d.paid.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                <td class="p-2 text-xs text-right">${d.balance.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                <td class="p-2 text-xs text-right">${d.currentDue.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                <td class="p-2 text-xs text-right text-yellow-400">${d.pastDue.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                            </tr>
                        `).join('');

                        if (stmt.details.length === 0) {
                            detailsHTML = `<tr><td colspan="7" class="text-center p-4 text-sm text-gray-400">No pledge details for this statement.</td></tr>`;
                        }

                        return `
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-x-8 gap-y-4 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                                    <div><p class="text-xs text-gray-400">Total Pledge</p><p class="text-lg font-semibold">${stmt.pledge.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div>
                                    <div><p class="text-xs text-gray-400">Total Paid/Adjusted</p><p class="text-lg font-semibold">${stmt.paid.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div>
                                    <div><p class="text-xs text-gray-400">Total Balance</p><p class="text-lg font-semibold text-primary">${stmt.balance.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div>
                                    <div><p class="text-xs text-gray-400">Recipient</p><p class="text-sm font-semibold">${stmt.recipient}</p></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-md mb-2">Pledge Details</h4>
                                    <div class="bg-gray-900/50 rounded-lg border border-gray-700 overflow-hidden">
                                        <table class="w-full">
                                            <thead class="bg-gray-700/50">
                                                <tr>
                                                    ${['Year', 'Type', 'Pledge', 'Paid', 'Balance', 'Current', 'Past Due'].map(h => `<th class="p-2 text-left text-xs font-semibold uppercase tracking-wider ${['Pledge', 'Paid', 'Balance', 'Current', 'Past Due'].includes(h) ? 'text-right' : ''}">${h}</th>`).join('')}
                                                </tr>
                                            </thead>
                                            <tbody>${detailsHTML}</tbody>
                                        </table>
                                    </div>
                                </div>
                                 <div class="flex gap-4 pt-4 border-t border-gray-700">
                                    <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold"><i class="fa-solid fa-print mr-2"></i>Print Statement</button>
                                    <button class="w-full text-center py-2 px-4 rounded-lg bg-red-800/50 text-red-300 hover:bg-red-800/80 transition font-semibold ${stmt.status === 'void' ? 'hidden':''}"><i class="fa-solid fa-times-circle mr-2"></i>Void Statement</button>
                                </div>
                            </div>`;
                    };

                    const filterAndRenderStatements = () => {
                        const searchTerm = searchInput.value.toLowerCase();
                        const selectedStatus = statusFilter.value;
                        
                        renderStatements(statementData); // Render first to calculate currentStatus

                        const filtered = statementData.filter(item => {
                            const searchMatch = item.recipient.toLowerCase().includes(searchTerm) || item.id.toString().includes(searchTerm);
                            const statusMatch = (selectedStatus === 'all' || item.currentStatus === selectedStatus);
                            return searchMatch && statusMatch;
                        });
                        renderStatements(filtered);
                    };

                    [searchInput, statusFilter].forEach(el => el.addEventListener('input', filterAndRenderStatements));
                    statementLogList.addEventListener('click', (e) => {
                        const item = e.target.closest('.statement-item');
                        if (item && typeof window.parent.showAppModal === 'function') {
                            const stmtId = parseInt(item.dataset.statementId, 10);
                            const statement = statementData.find(s => s.id === stmtId);
                            if (statement) {
                                window.parent.showAppModal(`Statement Log: #${statement.id}`, createStatementModalHTML(statement));
                            }
                        }
                    });

                    filterAndRenderStatements();
                }

                // --- THANK YOU LETTERS LOGIC ---
                const thankYouLogList = document.getElementById('thank-you-log-list');
                if (thankYouLogList) {
                    const thankYouData = [
                        { id: 22008, seq: 1, status: 'Downloaded', letterCode: 'Aloha', recipient: 'Patel, Anika', org: 'Starlight Foundation', pledge: 3000.00, paid: 3000.00, date: '2025-09-02', address: 'Ms. Anika Patel<br>Starlight Foundation<br>** Do not contact', transactions: [{procDate: '2025-09-01', accDate: '2025-09-01', trans: 14795, org: '500/Individual', pledge: 3000.00, payment: 3000.00, type: 'Cash'}] },
                        { id: 19762, seq: 11, status: 'Downloaded', letterCode: 'Planned Gift', recipient: 'Sullivan, Liam', org: '', pledge: 5000.00, paid: 5000.00, date: '2024-08-15', address: 'Mr. Liam Sullivan<br>123 Main Street<br>Anytown, USA 15003', transactions: [{procDate: '2024-08-14', accDate: '2024-08-14', trans: 11200, org: '500/Individual', pledge: 5000.00, payment: 5000.00, type: 'Check'}] },
                        { id: 23015, seq: 2, status: 'Pending', letterCode: 'Standard', recipient: 'Innovate Corp', org: '', pledge: 1500.00, paid: 0.00, date: '2025-08-20', address: 'Innovate Corp<br>555 Tech Drive', transactions: [{procDate: '2025-08-20', accDate: '2025-08-20', trans: 15001, org: '501/Corporate', pledge: 1500.00, payment: 0.00, type: 'Pledge'}] },
                    ];

                    const searchInput = document.getElementById('thank-you-search-input');
                    const statusFilter = document.getElementById('thank-you-status-filter');

                    const renderThankYouLetters = (data) => {
                        thankYouLogList.innerHTML = '';
                        if (data.length === 0) {
                            thankYouLogList.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">No letters found matching your criteria.</p>';
                            return;
                        }
                        data.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'log-item thank-you-item';
                            itemEl.dataset.letterId = item.id;
                            const statusMap = { 'Downloaded': { i: 'fa-check-double', c: 'green' }, 'Pending': { i: 'fa-clock', c: 'yellow' } };
                            const icon = statusMap[item.status] || { i: 'fa-question-circle', c: 'gray' };
                            itemEl.innerHTML = `
                                <div class="log-icon bg-${icon.c}-100 text-${icon.c}-600 dark:bg-${icon.c}-900/50 dark:text-${icon.c}-400"><i class="fa-solid ${icon.i}"></i></div>
                                <div class="text-sm text-gray-400 font-mono">${item.id}</div>
                                <div class="log-content"><p class="font-semibold">${item.recipient}</p><p class="text-xs text-gray-400 truncate">${item.org || 'Individual'}</p></div>
                                <div class="text-sm text-gray-300">${item.letterCode}</div>
                                <div class="text-sm text-gray-400 text-right font-semibold">${item.pledge.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</div>
                                <div class="text-xs text-gray-400 text-right">${new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>`;
                            thankYouLogList.appendChild(itemEl);
                        });
                    };

                    const createThankYouModalHTML = (letter) => {
                        let transactionsHTML = letter.transactions.map(t => `
                             <tr class="border-b border-gray-700 last:border-b-0">
                                <td class="p-2 text-xs">${new Date(t.procDate).toLocaleDateString('en-US')}</td>
                                <td class="p-2 text-xs">${new Date(t.accDate).toLocaleDateString('en-US')}</td>
                                <td class="p-2 text-xs font-mono">${t.trans}</td>
                                <td class="p-2 text-xs">${t.org}</td>
                                <td class="p-2 text-xs text-right">${t.pledge.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                                <td class="p-2 text-xs text-right">${t.payment.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                             </tr>
                        `).join('');

                        return `
                            <div class="space-y-4">
                                <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                                    <h4 class="text-sm font-semibold mb-2">Salutation & Address</h4>
                                    <p class="text-gray-300 whitespace-pre-wrap font-mono text-sm">${letter.address}</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                                    <div><p class="text-xs text-gray-400">Total Pledge</p><p class="text-lg font-semibold">${letter.pledge.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div>
                                    <div><p class="text-xs text-gray-400">Total Paid</p><p class="text-lg font-semibold text-primary">${letter.paid.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-md mb-2">Associated Transactions</h4>
                                     <div class="bg-gray-900/50 rounded-lg border border-gray-700 overflow-hidden">
                                        <table class="w-full">
                                            <thead class="bg-gray-700/50">
                                                <tr>
                                                    ${['Proc. Date', 'Acct. Date', 'Trans#', 'Org', 'Pledge', 'Payment'].map(h => `<th class="p-2 text-left text-xs font-semibold uppercase tracking-wider ${['Pledge', 'Payment'].includes(h) ? 'text-right' : ''}">${h}</th>`).join('')}
                                                </tr>
                                            </thead>
                                            <tbody>${transactionsHTML}</tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="flex gap-4 pt-4 border-t border-gray-700">
                                    <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold"><i class="fa-solid fa-print mr-2"></i>Preview Letter</button>
                                    <button class="w-full text-center py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 transition font-semibold"><i class="fa-solid fa-download mr-2"></i>Download</button>
                                </div>
                            </div>`;
                    };

                    const filterAndRenderThankYouLetters = () => {
                        const searchTerm = searchInput.value.toLowerCase();
                        const selectedStatus = statusFilter.value;
                        const filtered = thankYouData.filter(item => {
                            const searchMatch = item.recipient.toLowerCase().includes(searchTerm) || item.id.toString().includes(searchTerm);
                            const statusMatch = (selectedStatus === 'all' || item.status === selectedStatus);
                            return searchMatch && statusMatch;
                        });
                        renderThankYouLetters(filtered);
                    };

                    [searchInput, statusFilter].forEach(el => el.addEventListener('input', filterAndRenderThankYouLetters));
                    thankYouLogList.addEventListener('click', (e) => {
                        const item = e.target.closest('.thank-you-item');
                        if (item && typeof window.parent.showAppModal === 'function') {
                            const letterId = parseInt(item.dataset.letterId, 10);
                            const letter = thankYouData.find(s => s.id === letterId);
                            if (letter) {
                                window.parent.showAppModal(`Thank You Letter: #${letter.id}`, createThankYouModalHTML(letter));
                            }
                        }
                    });

                    filterAndRenderThankYouLetters();
                }

            } catch (error) {
                console.error("Communications.js: An unexpected error occurred:", error);
            }
        });
    </script>
</body>
</html>

